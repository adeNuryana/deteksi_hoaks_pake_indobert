<!-- templates/detection_app/result.html -->
{% extends 'detection_app/base.html' %}
{% load custom_filters %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow">
            <div class="card-header {% if result.prediction == 'HOAX' %}bg-danger{% else %}bg-success{% endif %} text-white">
                <h4 class="mb-0">
                    <i class="fas fa-{% if result.prediction == 'HOAX' %}exclamation-triangle{% else %}check-circle{% endif %} me-2"></i>
                    Hasil Deteksi
                </h4>
            </div>
            <div class="card-body">
                <!-- Result Summary -->
                <div class="alert {% if result.prediction == 'HOAX' %}alert-danger{% else %}alert-success{% endif %}">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="alert-heading">
                                {% if result.prediction == 'HOAX' %}
                                    <i class="fas fa-exclamation-triangle"></i> BERITA HOAX
                                {% else %}
                                    <i class="fas fa-check-circle"></i> BERITA VALID
                                {% endif %}
                            </h5>
                            <p class="mb-0">{{ result.explanation|default:"Tidak ada penjelasan tersedia." }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <h1 class="display-4 fw-bold {% if result.prediction == 'HOAX' %}text-danger{% else %}text-success{% endif %}">
                                {{ result.confidence|format_percent }}%
                            </h1>
                            <small>Tingkat Keyakinan</small>
                        </div>
                    </div>
                </div>
                
                <!-- Probability Distribution -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Distribusi Probabilitas</h6>
                            </div>
                            <div class="card-body">
                                <div class="progress mb-2" style="height: 30px;">
                                    {% with valid_width=result.valid_probability|format_float:3|multiply:100 %}
                                    <div class="progress-bar bg-success" 
                                         role="progressbar" 
                                         style="width: {{ valid_width }}%">
                                        Valid: {{ result.valid_probability|format_float:3 }}
                                    </div>
                                    {% endwith %}
                                </div>
                                <div class="progress" style="height: 30px;">
                                    {% with hoax_width=result.hoax_probability|format_float:3|multiply:100 %}
                                    <div class="progress-bar bg-danger" 
                                         role="progressbar" 
                                         style="width: {{ hoax_width }}%">
                                        Hoax: {{ result.hoax_probability|format_float:3 }}
                                    </div>
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Level Risiko</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <h1 class="display-3 
                                        {% if result.risk_level == 'SANGAT TINGGI' %}text-danger
                                        {% elif result.risk_level == 'TINGGI' %}text-warning
                                        {% elif result.risk_level == 'SEDANG' %}text-info
                                        {% else %}text-success{% endif %}">
                                        {% if result.risk_level == 'SANGAT TINGGI' %}
                                            <i class="fas fa-radiation"></i>
                                        {% elif result.risk_level == 'TINGGI' %}
                                            <i class="fas fa-exclamation-triangle"></i>
                                        {% elif result.risk_level == 'SEDANG' %}
                                            <i class="fas fa-info-circle"></i>
                                        {% else %}
                                            <i class="fas fa-check-circle"></i>
                                        {% endif %}
                                    </h1>
                                    <h4 class="fw-bold">{{ result.risk_level|default:"TIDAK DIKETAHUI" }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Text Analysis -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analisis Teks</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div class="display-6">{{ result.text_analysis.word_count|default:"0" }}</div>
                                <small>Kata</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="display-6">{{ result.text_analysis.sentence_count|default:"0" }}</div>
                                <small>Kalimat</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="display-6">{{ result.text_analysis.exclamation_count|default:"0" }}</div>
                                <small>Tanda Seru</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="display-6">{{ result.text_analysis.capital_ratio|default:"0"|format_float:2 }}</div>
                                <small>Rasio Huruf Kapital</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detected Patterns -->
                {% if result.patterns_detected %}
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Pola Hoax Terdeteksi
                        </h6>
                    </div>
                    <div class="card-body">
                        {% for pattern in result.patterns_detected %}
                        <div class="alert alert-warning mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ pattern.type }}</strong>: {{ pattern.description }}
                                    <br><small class="text-muted">Pola: {{ pattern.pattern|truncate_words:10 }}</small>
                                </div>
                                <div>
                                    <span class="badge bg-{% if pattern.severity == 3 %}danger{% elif pattern.severity == 2 %}warning{% else %}info{% endif %}">
                                        Level {{ pattern.severity }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Risk Factors & Suggestions -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Faktor Risiko</h6>
                            </div>
                            <div class="card-body">
                                {% if result.risk_factors %}
                                <ul class="mb-0">
                                    {% for factor in result.risk_factors %}
                                    <li>{{ factor }}</li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="text-muted mb-0">Tidak ada faktor risiko yang terdeteksi</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Saran</h6>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    {% for suggestion in result.suggestions %}
                                    <li>{{ suggestion }}</li>
                                    {% endfor %}
                                    <li>Selalu verifikasi informasi dari sumber resmi</li>
                                    <li>Periksa tanggal dan sumber berita</li>
                                    <li>Gunakan akal sehat sebelum menyebarkan</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Original Text -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Teks Asli</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light">
                            {{ result.text|truncatechars:500|default:"Teks tidak tersedia" }}
                            {% if result.text|length > 500 %}
                            <span id="more-text" style="display: none;">{{ result.text|slice:"500:" }}</span>
                            <a href="javascript:void(0)" onclick="toggleMoreText()" id="show-more-btn" class="text-primary">
                                Tampilkan lebih banyak...
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{% url 'detect' %}" class="btn btn-outline-primary">
                                <i class="fas fa-redo me-1"></i> Deteksi Lainnya
                            </a>
                            {% if detection.source_url %}
                            <a href="{{ detection.source_url }}" target="_blank" class="btn btn-outline-info">
                                <i class="fas fa-external-link-alt me-1"></i> Kunjungi Sumber
                            </a>
                            {% endif %}
                        </div>
                        <div>
                            <button onclick="window.print()" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-print me-1"></i> Cetak
                            </button>
                            {% if user.is_authenticated %}
                            <a href="{% url 'detection_detail' detection.id %}" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Simpan ke History
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function toggleMoreText() {
    var moreText = document.getElementById("more-text");
    var btn = document.getElementById("show-more-btn");
    
    if (moreText.style.display === "none") {
        moreText.style.display = "inline";
        btn.textContent = "Tampilkan lebih sedikit...";
    } else {
        moreText.style.display = "none";
        btn.textContent = "Tampilkan lebih banyak...";
    }
}

// Create probability chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.createElement('canvas');
    ctx.id = 'probabilityChart';
    document.querySelector('.card-body').prepend(ctx);
    
    // Data untuk chart
    const hoaxProb = {{ result.hoax_probability|default:0 }};
    const validProb = {{ result.valid_probability|default:0 }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Valid', 'Hoax'],
            datasets: [{
                data: [validProb, hoaxProb],
                backgroundColor: [
                    '#28a745',
                    '#dc3545'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Distribusi Probabilitas'
                }
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %}